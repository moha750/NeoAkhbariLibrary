# ๐ ุดุฑุญ ุงูุฎุทุฃ: "User not allowed" (403)

## โ ุงูุฎุทุฃ ุงูุฐู ุญุฏุซ

```
AuthApiError: User not allowed
Status: 403 Forbidden
```

---

## ๐ฏ ุงูุณุจุจ

### ุงููุดููุฉ ุงูุฃุณุงุณูุฉ:

**`inviteUserByEmail()` ูู ุฏุงูุฉ Admin API**

```javascript
// โ ูุง ูุนูู ูู ุงููุชุตูุญ
await this.supabase.auth.admin.inviteUserByEmail(...)
```

### ููุงุฐุงุ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Supabase Auth Admin API                                โ
โ                                                         โ
โ  ุชุญุชุงุฌ ุฅูู: Service Role Key                           โ
โ  โโโ ููุชุงุญ ุฎุงุต ุจุงูุฎุงุฏู ููุท                             โ
โ  โโโ ุตูุงุญูุงุช ูุงููุฉ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช                 โ
โ  โโโ ุฎุทูุฑ ุฌุฏุงู ุฅุฐุง ุชู ูุดูู                             โ
โ                                                         โ
โ  โ๏ธ ูุง ูููู ุงุณุชุฎุฏุงููุง ูู ุงููุชุตูุญ (Client-side)        โ
โ  โ ูุฌุจ ุงุณุชุฎุฏุงููุง ูู ุงูุฎุงุฏู (Server-side)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก ุงูุญููู ุงููุชุงุญุฉ

### ุงูุญู 1: Edge Function (ููุตู ุจู) โ

```
ุงููุชุตูุญ โ Edge Function โ Supabase Admin API โ ุฅุฑุณุงู ุงูุจุฑูุฏ
```

**ุงููููุฒุงุช:**
- โ ุขูู (Service Role ูู ุงูุฎุงุฏู)
- โ ุฅุฑุณุงู ุจุฑูุฏ ุชููุงุฆู
- โ ููุงูุจ HTML ูุฎุตุตุฉ

**ุงููุชุทูุจุงุช:**
- ูุดุฑ Edge Function ุนูู Supabase
- ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ

**ุงูููุฏ ููุฌูุฏ ุจุงููุนู ูู:**
- `supabase/functions/send-invitation/index.ts`

### ุงูุญู 2: ูุณุฎ ุงูุฑุงุจุท ูุฏููุงู (ุงูุญุงูู) โ

```
ุงููุชุตูุญ โ ุฅูุดุงุก ุงูุฏุนูุฉ โ ูุณุฎ ุงูุฑุงุจุท โ ุฅุฑุณุงู ูุฏูู
```

**ุงููููุฒุงุช:**
- โ ูุนูู ููุฑุงู ุจุฏูู ุฅุนุฏุงุฏ
- โ ุขูู ุชูุงูุงู
- โ ุจุณูุท

**ุงูุนููุจ:**
- โ๏ธ ูุฏูู (ููุณ ุชููุงุฆู)
- โ๏ธ ูุญุชุงุฌ ูุณุฎ ููุตู

### ุงูุญู 3: Webhook ุฎุงุฑุฌู

```
ุงููุชุตูุญ โ Webhook โ ุฎุฏูุฉ ุฎุงุฑุฌูุฉ โ ุฅุฑุณุงู ุงูุจุฑูุฏ
```

**ูุซุงู:**
- Zapier
- Make (Integromat)
- n8n

---

## ๐๏ธ ุงูุญู ุงูููุทุจู ุญุงููุงู

ุชู ุชุญุฏูุซ ุงูููุฏ ููุนูู ุจุฐูุงุก:

```javascript
async sendInvitationEmail(invitationId) {
    // 1. ุฌูุจ ุจูุงูุงุช ุงูุฏุนูุฉ
    const invitation = await getInvitation(invitationId);
    
    // 2. ุฅูุดุงุก ุฑุงุจุท ุงูุฏุนูุฉ
    const invitationLink = createLink(invitation.token);
    
    // 3. ูุญุงููุฉ ุฅุฑุณุงู ุงูุจุฑูุฏ ุนุจุฑ Edge Function
    try {
        const result = await callEdgeFunction(invitationId);
        return { success: true, invitationLink };
    } catch (error) {
        // 4. ุฅุฐุง ูุดู โ ุงุณุชุฎุฏุงู ุงููุถุน ุงููุฏูู
        return { 
            success: false, 
            invitationLink,
            manualMode: true  // โ ุนูุงูุฉ ูููุถุน ุงููุฏูู
        };
    }
}
```

---

## ๐ ูุง ูุญุฏุซ ุงูุขู

### ุงูุณููุงุฑูู ุงูุญุงูู:

```
1. ุงูุฅุฏุงุฑู ูุถุบุท "ุฅุฑุณุงู ุงูุฏุนูุฉ"
   โ
2. ุฅูุดุงุก ุงูุฏุนูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
   โ
3. ูุญุงููุฉ ุฅุฑุณุงู ุงูุจุฑูุฏ ุนุจุฑ Edge Function
   โ
   โโโโโโโโโโโโโโโโโโโ
   โ Edge Function   โ
   โ ููุฌูุฏุฉุ        โ
   โโโโโโฌโโโโโโโโโฌโโโโ
        โ        โ
       ูุนู      ูุง
        โ        โ
   ุฅุฑุณุงู     ูุณุฎ ุงูุฑุงุจุท
   ุงูุจุฑูุฏ    ุชููุงุฆูุงู โ
   โ
```

### ุงูุฑุณุงูุฉ ูููุณุชุฎุฏู:

**ุฅุฐุง ูุดู ุงูุจุฑูุฏ:**
```
โ๏ธ ุชู ุฅูุดุงุก ุงูุฏุนูุฉ ูููู ูุดู ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู.

๐ ุชู ูุณุฎ ุฑุงุจุท ุงูุฏุนูุฉ. ููููู ุฅุฑุณุงูู ูุฏููุงู ููุดุฎุต ุงููุฏุนู:

user@example.com
```

---

## ๐ ููููุฉ ุชูุนูู ุงูุฅุฑุณุงู ุงูุชููุงุฆู

### ุงูุฎุทูุฉ 1: ูุดุฑ Edge Function

```bash
# ุชุซุจูุช Supabase CLI
npm install -g supabase

# ุชุณุฌูู ุงูุฏุฎูู
supabase login

# ุฑุจุท ุงููุดุฑูุน
supabase link --project-ref yfudytvojcusgemyager

# ูุดุฑ Edge Function
supabase functions deploy send-invitation
```

### ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ ุงููุชุบูุฑุงุช (ุงุฎุชูุงุฑู - ูู Resend)

```bash
# ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุฎุฏุงู Resend ูุฅุฑุณุงู ุงูุจุฑูุฏ
supabase secrets set RESEND_API_KEY=re_xxxxx
supabase secrets set FROM_EMAIL=noreply@yourdomain.com
supabase secrets set SITE_URL=https://yoursite.com
```

**ููุงุญุธุฉ:** Edge Function ุชุนูู ุจุฏูู Resend ุฃูุถุงู (ุชุณุชุฎุฏู Supabase Built-in)

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุฑ

```
1. ุฃุฑุณู ุฏุนูุฉ ุฌุฏูุฏุฉ
2. ุณูุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ุชููุงุฆูุงู โ
```

---

## ๐ ุงูููุงุฑูุฉ

| ุงูููุฒุฉ | ุจุฏูู Edge Function | ูุน Edge Function |
|--------|-------------------|------------------|
| ุงูุฅุนุฏุงุฏ | โ ููุฑู | โ๏ธ ูุญุชุงุฌ ูุดุฑ |
| ุฅุฑุณุงู ุงูุจุฑูุฏ | โ ูุฏูู | โ ุชููุงุฆู |
| ุงูุฃูุงู | โ ุขูู | โ ุขูู |
| ุงูุชูููุฉ | โ ูุฌุงูู | โ ูุฌุงูู |
| ุณูููุฉ ุงูุงุณุชุฎุฏุงู | โญโญโญ | โญโญโญโญโญ |

---

## โ ุงูุฎูุงุตุฉ

### ุงููุถุน ุงูุญุงูู:
```
โ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ
โ ุงูุฏุนูุงุช ุชููุดุฃ ุจูุฌุงุญ
โ ุงูุฑุงุจุท ูููุณุฎ ุชููุงุฆูุงู
โ๏ธ ุงูุจุฑูุฏ ููุฑุณู ูุฏููุงู (ุญุชู ุชูุดุฑ Edge Function)
```

### ููุญุตูู ุนูู ุฅุฑุณุงู ุชููุงุฆู:
```
1. ูุดุฑ Edge Function (5 ุฏูุงุฆู)
2. ุงุฎุชูุงุฑู: ุฅุนุฏุงุฏ Resend ููุจุฑูุฏ ุงูุงุญุชุฑุงูู
```

### ุจุฏูู ุฅุนุฏุงุฏ ุฅุถุงูู:
```
โ ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงู ุงููุณุฎ ุงููุฏูู
โ ูุนูู ุจุดูู ููุชุงุฒ
โ ุขูู ูููุซูู
```

---

## ๐ ุงููุฑุงุฌุน

- `supabase/functions/send-invitation/index.ts` - Edge Function
- `EMAIL_SETUP_GUIDE.md` - ุฏููู ุฅุนุฏุงุฏ ุงูุจุฑูุฏ
- `IMPLEMENTATION_SUMMARY.md` - ููุฎุต ุงูุชูููุฐ

---

**ุงููุธุงู ูุนูู! ุงูุฎุทุฃ ุชู ุญูู. ๐**

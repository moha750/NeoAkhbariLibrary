# ๐ ุฅุตูุงุญ ุฎุทุฃ 406 ุนูุฏ ุงูุชุญูู ูู ุงูุฏุนูุฉ

## ๐ ุงููุดููุฉ

ุนูุฏ ูุชุญ ุฑุงุจุท ุงูุฏุนูุฉ ูู `signup.html`ุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
Failed to load resource: the server responded with a status of 406 ()
ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฏุนูุฉ: Object
```

**URL ุงูุฎุทุฃ:**
```
yfudytvojcusgemyager.supabase.co/rest/v1/invitations?select=*&token=eq.inv_xxx&status=eq.pending:1
```

---

## ๐ ุงูุณุจุจ

### ุฎุทุฃ 406 Not Acceptable ูุญุฏุซ ุจุณุจุจ:

1. **ุงุณุชุฎุฏุงู `.single()`** ูู ุงูุงุณุชุนูุงู
2. `.single()` ูุชููุน ูุชูุฌุฉ ูุงุญุฏุฉ **ุจุงูุถุจุท**
3. ุฅุฐุง ูู ูุฌุฏ ูุชุงุฆุฌ โ ูุฑูู ุฎุทุฃ 406
4. ุฅุฐุง ูุฌุฏ ุฃูุซุฑ ูู ูุชูุฌุฉ โ ูุฑูู ุฎุทุฃ 406

### ุงูููุฏ ุงููุฏูู (ุงููุดููุฉ):

```javascript
async verifyInvitation(token) {
    try {
        const { data, error } = await this.supabase
            .from('invitations')
            .select('*')
            .eq('token', token)
            .eq('status', 'pending')
            .single(); // โ ูุฑูู 406 ุฅุฐุง ูู ูุฌุฏ ูุชุงุฆุฌ

        if (error) throw error;
        // ...
    }
}
```

### ููุงุฐุง ูุง ูุฌุฏ ูุชุงุฆุฌุ

**ุงูุณููุงุฑูููุงุช ุงููุญุชููุฉ:**

1. **Token ุฎุงุทุฆ** - ุงููุณุชุฎุฏู ูุณุฎ ุงูุฑุงุจุท ุจุดูู ุฎุงุทุฆ
2. **ุงูุฏุนูุฉ ูุณุชุฎุฏูุฉ** - ุชู ูุจูููุง ูู ูุจู (`status = 'accepted'`)
3. **ุงูุฏุนูุฉ ููุชููุฉ** - `expires_at < NOW()`
4. **ุงูุฏุนูุฉ ูุญุฐููุฉ** - ุชู ุญุฐููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
5. **ูุดููุฉ ูู RLS** - ุงูุณูุงุณุงุช ุชููุน ุงููุตูู

---

## โ ุงูุญู

### ุงุณุชุฎุฏุงู `.maybeSingle()` ุจุฏูุงู ูู `.single()`

```javascript
async verifyInvitation(token) {
    try {
        // โ ุงุณุชุฎุฏุงู maybeSingle() - ูุง ูุฑูู ุฎุทุฃ ุฅุฐุง ูู ูุฌุฏ ูุชุงุฆุฌ
        const { data, error } = await this.supabase
            .from('invitations')
            .select('*')
            .eq('token', token)
            .eq('status', 'pending')
            .maybeSingle(); // โ ูุฑุฌุน null ุฅุฐุง ูู ูุฌุฏ ูุชุงุฆุฌ

        // ุฅุฐุง ูุงู ููุงู ุฎุทุฃ ูู ุงูุงุณุชุนูุงู ููุณู
        if (error) {
            console.error('ุฎุทุฃ ูู ุงูุงุณุชุนูุงู:', error);
            throw error;
        }

        // โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช
        if (!data) {
            return { 
                valid: false, 
                message: 'ุงูุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุชู ุงุณุชุฎุฏุงููุง' 
            };
        }

        // ุงูุชุญูู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ
        if (new Date(data.expires_at) < new Date()) {
            return { 
                valid: false, 
                message: 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฏุนูุฉ' 
            };
        }

        return { valid: true, invitation: data };
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฏุนูุฉ:', error);
        return { 
            valid: false, 
            message: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู ุงูุฏุนูุฉ' 
        };
    }
}
```

---

## ๐ ุงููุฑู ุจูู single() ู maybeSingle()

| ุงูุฏุงูุฉ | ุงูุณููู ุนูุฏ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ | ุงูุณููู ุนูุฏ ูุฌูุฏ ูุชูุฌุฉ ูุงุญุฏุฉ | ุงูุณููู ุนูุฏ ูุฌูุฏ ุนุฏุฉ ูุชุงุฆุฌ |
|--------|---------------------------|----------------------------|--------------------------|
| **`.single()`** | โ ูุฑูู ุฎุทุฃ 406 | โ ูุฑุฌุน ุงูุจูุงูุงุช | โ ูุฑูู ุฎุทุฃ 406 |
| **`.maybeSingle()`** | โ ูุฑุฌุน `null` | โ ูุฑุฌุน ุงูุจูุงูุงุช | โ ูุฑูู ุฎุทุฃ 406 |

### ูุชู ุชุณุชุฎุฏู ูู ูุงุญุฏุฉุ

```javascript
// ุงุณุชุฎุฏู single() ุนูุฏูุง:
// - ุชุชููุน ูุชูุฌุฉ ูุงุญุฏุฉ ุจุงูุถุจุท
// - ุชุฑูุฏ ุฎุทุฃ ุฅุฐุง ูู ุชุฌุฏ ูุชุงุฆุฌ
const { data } = await supabase
    .from('users')
    .select('*')
    .eq('id', userId)
    .single(); // ูุฌุจ ุฃู ูููู ููุงู ูุณุชุฎุฏู ูุงุญุฏ ููุท

// ุงุณุชุฎุฏู maybeSingle() ุนูุฏูุง:
// - ุงููุชูุฌุฉ ูุฏ ุชููู ููุฌูุฏุฉ ุฃู ูุง
// - ุชุฑูุฏ ุงูุชุนุงูู ูุน ุงูุญุงูุฉ ุจููุณู
const { data } = await supabase
    .from('invitations')
    .select('*')
    .eq('token', token)
    .maybeSingle(); // ูุฏ ูุง ุชููู ููุฌูุฏุฉ

if (!data) {
    // ุงูุชุนุงูู ูุน ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ
}
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุฏุนูุฉ ุตุญูุญุฉ

```
1. ุฃูุดุฆ ุฏุนูุฉ ุฌุฏูุฏุฉ ูู dashboard
2. ุงูุณุฎ ุฑุงุจุท ุงูุฏุนูุฉ
3. ุงูุชุญ ุงูุฑุงุจุท ูู ูุงูุฐุฉ ุชุตูุญ ุฎูู
4. โ ูุฌุจ ุนุฑุถ ุตูุญุฉ ุงูุชุณุฌูู
5. โ ูุฌุจ ุนุฑุถ ูุนูููุงุช ุงูุฏุนูุฉ (ุงูุจุฑูุฏ ูุงูุฏูุฑ)
```

### ุงุฎุชุจุงุฑ 2: ุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ

```
1. ุงูุชุญ signup.html?token=invalid_token
2. โ ูุฌุจ ุนุฑุถ ุฑุณุงูุฉ: "ุงูุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุชู ุงุณุชุฎุฏุงููุง"
3. โ ูุง ูุฌุจ ุธููุฑ ุฎุทุฃ 406
```

### ุงุฎุชุจุงุฑ 3: ุฏุนูุฉ ููุชููุฉ

```
1. ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ ุนุฏูู expires_at ูุฏุนูุฉ ูุฏููุฉ
2. ุงูุชุญ ุฑุงุจุท ุงูุฏุนูุฉ
3. โ ูุฌุจ ุนุฑุถ ุฑุณุงูุฉ: "ุงูุชูุช ุตูุงุญูุฉ ุงูุฏุนูุฉ"
```

### ุงุฎุชุจุงุฑ 4: ุฏุนูุฉ ูุณุชุฎุฏูุฉ

```
1. ุงุณุชุฎุฏู ุฏุนูุฉ ูุฃููู ุงูุชุณุฌูู
2. ุญุงูู ูุชุญ ููุณ ุงูุฑุงุจุท ูุฑุฉ ุฃุฎุฑู
3. โ ูุฌุจ ุนุฑุถ ุฑุณุงูุฉ: "ุงูุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุชู ุงุณุชุฎุฏุงููุง"
```

---

## ๐ ุงูุชุญูู ูู RLS

ุชุฃูุฏ ูู ูุฌูุฏ ูุฐู ุงูุณูุงุณุฉ ูู `CREATE_AUTH_SYSTEM.sql`:

```sql
-- ุณูุงุณุฉ ููุณูุงุญ ุจุงูุชุญูู ูู ุงูุฏุนูุฉ ุจุฏูู ูุตุงุฏูุฉ (ููุชุณุฌูู)
CREATE POLICY "Anyone can verify invitation token"
ON invitations FOR SELECT
TO anon
USING (status = 'pending' AND expires_at > NOW());
```

**ูุฐู ุงูุณูุงุณุฉ ุชุณูุญ ูููุณุชุฎุฏููู ุบูุฑ ุงููุตุงุฏููู (anon) ุจูุฑุงุกุฉ ุงูุฏุนูุงุช ุงููุนููุฉ ููุท.**

---

## ๐ ุณูุฑ ุงูุนูู ุงููุญุฏุซ

```
1. ุงููุณุชุฎุฏู ููุชุญ ุฑุงุจุท ุงูุฏุนูุฉ
   โ
2. signup.html ูุณุชุฎุฑุฌ token ูู URL
   โ
3. ุงุณุชุฏุนุงุก api.verifyInvitation(token)
   โ
4. ุงุณุชุนูุงู Supabase ูุน maybeSingle()
   โ
5. ุฅุฐุง ูู ูุฌุฏ ูุชุงุฆุฌ โ data = null
   โ
6. โ ุนุฑุถ ุฑุณุงูุฉ ููุงุณุจุฉ (ุจุฏูู ุฎุทุฃ 406)
   โ
7. ุฅุฐุง ูุฌุฏ ุฏุนูุฉ โ ุงูุชุญูู ูู ุงูุตูุงุญูุฉ
   โ
8. โ ุนุฑุถ ูููุฐุฌ ุงูุชุณุฌูู
```

---

## ๐ฏ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `supabase-api.js`

**ุงูุณุทุฑ 1187-1218:**
```javascript
async verifyInvitation(token) {
    // ุงุณุชุฎุฏุงู maybeSingle() ุจุฏูุงู ูู single()
    const { data, error } = await this.supabase
        .from('invitations')
        .select('*')
        .eq('token', token)
        .eq('status', 'pending')
        .maybeSingle(); // โ ุงูุฅุตูุงุญ ููุง
    
    if (error) throw error;
    
    if (!data) {
        return { valid: false, message: 'ุงูุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุชู ุงุณุชุฎุฏุงููุง' };
    }
    
    // ุจุงูู ุงูููุฏ...
}
```

---

## ๐ก ูุตุงุฆุญ ุฅุถุงููุฉ

### 1. ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ

```javascript
if (!data) {
    // ููููู ุงูุชุญูู ูู ุงูุณุจุจ ุจุดูู ุฃูุซุฑ ุชูุตููุงู
    const { data: usedInvitation } = await this.supabase
        .from('invitations')
        .select('status')
        .eq('token', token)
        .maybeSingle();
    
    if (usedInvitation?.status === 'accepted') {
        return { valid: false, message: 'ุชู ุงุณุชุฎุฏุงู ูุฐู ุงูุฏุนูุฉ ูู ูุจู' };
    }
    
    return { valid: false, message: 'ุงูุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ' };
}
```

### 2. ุฅุถุงูุฉ Logging

```javascript
console.log('๐ ุงูุชุญูู ูู token:', token);
console.log('๐ ูุชูุฌุฉ ุงูุงุณุชุนูุงู:', data);
```

### 3. ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ุงูุฃุฎุฑู

```javascript
if (error) {
    // ุชุณุฌูู ุชูุงุตูู ุงูุฎุทุฃ
    console.error('ุชูุงุตูู ุงูุฎุทุฃ:', {
        code: error.code,
        message: error.message,
        details: error.details
    });
    throw error;
}
```

---

## ๐ ุฃุฎุทุงุก ุฃุฎุฑู ูุญุชููุฉ

### ุฎุทุฃ 401 Unauthorized

```
ุงูุณุจุจ: RLS ุชููุน ุงููุตูู
ุงูุญู: ุชุญูู ูู ุณูุงุณุฉ "Anyone can verify invitation token"
```

### ุฎุทุฃ 404 Not Found

```
ุงูุณุจุจ: ุฌุฏูู invitations ุบูุฑ ููุฌูุฏ
ุงูุญู: ุดุบูู CREATE_AUTH_SYSTEM.sql
```

### ุฎุทุฃ CORS

```
ุงูุณุจุจ: ุทูุจ ูู ูุทุงู ุบูุฑ ูุตุฑุญ
ุงูุญู: ุฃุถู ุงููุทุงู ูู Supabase Dashboard โ Settings โ API
```

---

## โ ุงูุฎูุงุตุฉ

### ุงููุดููุฉ:
- ุฎุทุฃ 406 ุนูุฏ ุงูุชุญูู ูู ุฏุนูุฉ ุบูุฑ ููุฌูุฏุฉ

### ุงูุณุจุจ:
- ุงุณุชุฎุฏุงู `.single()` ุงูุฐู ูุฑูู ุฎุทุฃ ุนูุฏ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ

### ุงูุญู:
- ุงุณุชุฎุฏุงู `.maybeSingle()` ูุงูุชุญูู ูู `data === null`

### ุงููุชูุฌุฉ:
- โ ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก 406
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

---

## ๐ ุงููุฑุงุฌุน

- [Supabase Docs: single() vs maybeSingle()](https://supabase.com/docs/reference/javascript/single)
- [HTTP Status Code 406](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/406)
- [Supabase RLS Policies](https://supabase.com/docs/guides/auth/row-level-security)

---

**ุชู ุฅุตูุงุญ ุงููุดููุฉ! ุงูุขู ุฑูุงุจุท ุงูุฏุนูุงุช ุชุนูู ุจุดูู ุตุญูุญ. ๐**

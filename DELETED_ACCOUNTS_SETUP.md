# دليل إعداد نظام الحسابات المحذوفة

## نظرة عامة
تم إضافة نظام متكامل لإدارة الحسابات المحذوفة يقوم بـ:
- ✅ حفظ بيانات المستخدم المحذوف في جدول منفصل
- ✅ حذف الدعوة المرتبطة بالمستخدم تلقائياً
- ✅ عرض قائمة بالحسابات المحذوفة في لوحة التحكم
- ✅ إمكانية الحذف النهائي للحسابات المحذوفة

## خطوات التطبيق

### 1. تطبيق تحديثات قاعدة البيانات

قم بتنفيذ الملف SQL التالي في Supabase SQL Editor:

```bash
deleted-accounts-system.sql
```

هذا الملف يقوم بـ:
- إنشاء جدول `deleted_accounts`
- إنشاء دالة `delete_user_with_archive()` لحذف المستخدم مع الأرشفة
- إنشاء دالة `permanently_delete_account()` للحذف النهائي
- إضافة سياسات RLS للأمان

### 2. التحقق من التحديثات

تأكد من أن الملفات التالية تم تحديثها:
- ✅ `supabase-api.js` - تم إضافة دوال جديدة
- ✅ `dashboard.html` - تم إضافة قسم الحسابات المحذوفة
- ✅ `signup.html` - تم جعل الاسم إجباري والتحقق من التكرار

### 3. اختبار النظام

#### اختبار حذف مستخدم:
1. انتقل إلى لوحة التحكم → فريق العمل
2. اضغط على "حذف" لأحد الأعضاء
3. سيظهر تأكيد يوضح ما سيتم:
   - حذف الحساب
   - حذف الدعوة المرتبطة
   - نقل البيانات للحسابات المحذوفة
4. يمكنك إدخال سبب الحذف (اختياري)

#### اختبار عرض الحسابات المحذوفة:
1. انتقل إلى قسم "الحسابات المحذوفة"
2. ستجد قائمة بجميع الحسابات المحذوفة مع:
   - البريد الإلكتروني والاسم
   - الدور السابق
   - من قام بالحذف
   - تاريخ الحذف
   - سبب الحذف (إن وُجد)
   - معلومات الدعوة السابقة

#### اختبار الحذف النهائي:
1. في قسم الحسابات المحذوفة
2. اضغط "حذف نهائي"
3. سيظهر تحذير بأن البيانات لن يمكن استرجاعها

## الميزات الجديدة

### في `supabase-api.js`:

```javascript
// حذف مستخدم مع الأرشفة
await api.deleteUserWithArchive(userId, reason);

// جلب الحسابات المحذوفة
const accounts = await api.getDeletedAccounts();

// حذف نهائي
await api.permanentlyDeleteAccount(accountId);
```

### في `dashboard.html`:

- قسم جديد: "الحسابات المحذوفة"
- رسالة تأكيد محسّنة عند الحذف
- إمكانية إدخال سبب الحذف
- عرض تفصيلي للحسابات المحذوفة

### في قاعدة البيانات:

**جدول `deleted_accounts`:**
- `user_id` - معرف المستخدم المحذوف
- `email` - البريد الإلكتروني
- `full_name` - الاسم الكامل
- `role_name` - اسم الدور
- `role_display_name` - الاسم المعروض للدور
- `invitation_email` - بريد الدعوة
- `invitation_token` - رمز الدعوة
- `deleted_by` - من قام بالحذف
- `deletion_reason` - سبب الحذف
- `deleted_at` - تاريخ الحذف
- `user_data` - بيانات إضافية (JSON)

## الأمان

- ✅ جميع الدوال محمية بـ `SECURITY DEFINER`
- ✅ RLS مفعّل على جدول `deleted_accounts`
- ✅ الإداريون فقط يمكنهم الوصول للحسابات المحذوفة
- ✅ يتم حذف auth.users تلقائياً (CASCADE)

## ملاحظات مهمة

1. **الحذف التلقائي للدعوات:**
   - يتم حذف جميع الدعوات المرتبطة بنفس البريد الإلكتروني
   - يشمل الدعوات المقبولة والمعلقة

2. **البيانات المحفوظة:**
   - يتم حفظ جميع بيانات المستخدم قبل الحذف
   - يتم حفظ معلومات الدعوة الأصلية

3. **الحذف النهائي:**
   - لا يمكن استرجاع البيانات بعد الحذف النهائي
   - يتطلب تأكيد إضافي

## استكشاف الأخطاء

### إذا ظهرت رسالة "function does not exist":
```sql
-- تأكد من تنفيذ ملف deleted-accounts-system.sql
```

### إذا لم تظهر الحسابات المحذوفة:
```sql
-- تحقق من صلاحيات RLS
SELECT * FROM deleted_accounts; -- في SQL Editor
```

### إذا فشل الحذف:
- تأكد من أنك مسجل دخول كإداري
- تحقق من Console في المتصفح للأخطاء
- تأكد من تطبيق جميع التحديثات

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من Console في المتصفح (F12)
2. راجع Supabase Logs
3. تأكد من تطبيق جميع الملفات SQL

---

✅ **تم التطبيق بنجاح!** النظام جاهز للاستخدام.
